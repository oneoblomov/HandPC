# Lightweight test-specific Dockerfile
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install minimal test dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    python3-tk \
    gjs \
    xvfb \
    git \
    libglib2.0-dev \
    libgtk-3-dev \
    libx11-dev \
    libxext-dev \
    libxtst-dev \
    libgirepository1.0-dev \
    gir1.2-gtk-3.0 \
    gir1.2-gdkpixbuf-2.0 \
    gir1.2-atk-1.0 \
    libcairo2-dev \
    meson \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# Install Python test packages and project dependencies
RUN pip3 install --upgrade pip && \
    pip3 install meson && \
    pip3 install \
    pytest>=7.0.0 \
    pytest-cov>=4.0.0 \
    black>=23.0.0 \
    flake8>=6.0.0 \
    numpy>=1.21.0 \
    opencv-python>=4.7.0 \
    mediapipe>=0.10.0 \
    pyautogui>=0.9.54 \
    pynput>=1.7.6 \
    dbus-python>=1.3.2 \
    PyGObject>=3.42.0 \
    packaging>=21.0 \
    'protobuf>=3.20.0,<4.21.0' \
    keyboard>=0.13.0 \
    mouse>=0.7.0

# Set up test environment
ENV DISPLAY=:99
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /workspace

# Default test command
CMD ["bash", "-c", "Xvfb :99 -screen 0 1920x1080x24 & sleep 2 && ./test.sh"]